import { Component, Input, OnDestroy, OnInit } from '@angular/core';

import { BehaviorSubject, Observable, Subscription } from 'rxjs';
import { filter, map, take } from 'rxjs/operators';

import { Item } from '../core/shared/item.model';
import { Community } from '../core/shared/community.model';
import { ExploitationPlanStateService } from './core/exploitation-plan-state.service';
import { ExploitationPlanStep } from './core/models/exploitation-plan-step.model';
import { hasValue } from '../shared/empty.util';
import { ActivatedRoute } from '@angular/router';

@Component({
  selector: 'ds-exploitation-plan',
  templateUrl: './exploitation-plan.component.html',
  styleUrls: ['./exploitation-plan.component.scss']
})
export class ExploitationPlanComponent implements OnInit, OnDestroy {
  /**
   * If the current user is a funder Organizational/Project manager
   */
  @Input() isFunder: boolean;

  /**
   * The exploitation Plan item
   */
  @Input() exploitationPlan: Item;

  /**
   * The project community id which the subproject belong to
   */
  @Input() public projectCommunityId: string;

  /**
   * The funding community which the exploitation Plan belong to
   */
  @Input() fundingCommunity: Community;

  public exploitationPlanId: string;

  /**
   * Array to track all subscriptions and unsubscribe them onDestroy
   */
  private subs: Subscription[] = [];

  /**
   * A boolean representing if compare mode is active
   */
  compareMode: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);

  /**
   * A boolean representing if item is a version of original item
   */
  public isVersionOfAnItem$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);

  constructor(
    protected exploitationPlanStateService: ExploitationPlanStateService,
    protected aroute: ActivatedRoute,
  ) {
  }

  ngOnInit(): void {
    this.exploitationPlanId = this.exploitationPlan?.id;

    this.subs.push(
      this.exploitationPlanStateService.isCompareModeActive()
        .subscribe((compareMode: boolean) => this.compareMode.next(compareMode))
    );

    this.aroute.data.pipe(
      map((data) => data.isVersionOfAnItem),
      filter((isVersionOfAnItem) => isVersionOfAnItem === true),
      take(1)
    ).subscribe((isVersionOfAnItem: boolean) => {
      this.isVersionOfAnItem$.next(isVersionOfAnItem);
    });

  }

  getExploitationPlanStep(): Observable<ExploitationPlanStep[]> {
    return this.exploitationPlanStateService.getExploitationPlanStep(this.exploitationPlanId);
  }

  isLoading(): Observable<boolean> {
    return this.exploitationPlanStateService.isExploitationPlanLoaded().pipe(
      map((loaded: boolean) => !loaded)
    );
  }

  /**
   * Dispatch initialization of comparing mode
   *
   * @param version
   */
  onVersionSelected(version: Item) {
    this.exploitationPlanStateService.dispatchInitCompare(this.exploitationPlan?.id, version.id, this.isVersionOfAnItem$.value);
  }

  /**
   * Dispatch cleaning of comparing mode
   */
  onVersionDeselected() {
    this.exploitationPlanStateService.dispatchStopCompare(this.exploitationPlan?.id);
  }

  /**
   * When destroy component clear all collapsed values.
   */
  ngOnDestroy() {
    this.exploitationPlanStateService.dispatchClearCollapsable();

    this.subs
      .filter((subscription) => hasValue(subscription))
      .forEach((subscription) => subscription.unsubscribe());
  }
}
