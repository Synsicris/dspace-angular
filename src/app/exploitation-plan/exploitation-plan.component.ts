import { Component, Input, OnDestroy, OnInit } from '@angular/core';

import { Observable, Subscription, BehaviorSubject } from 'rxjs';
import { map, tap } from 'rxjs/operators';

import { Item } from '../core/shared/item.model';
import { Community } from '../core/shared/community.model';
import { ExploitationPlanStateService } from './core/exploitation-plan-state.service';
import { ExploitationPlanStep } from './core/models/exploitation-plan-step.model';
import { hasValue } from '../shared/empty.util';

@Component({
  selector: 'ds-exploitation-plan',
  templateUrl: './exploitation-plan.component.html',
  styleUrls: ['./exploitation-plan.component.scss']
})
export class ExploitationPlanComponent implements OnInit, OnDestroy {

  /**
   * The exploitation Plan item
   */
  @Input() exploitationPlan: Item;

  /**
   * The project community id which the subproject belong to
   */
  @Input() public projectCommunityId: string;

  /**
   * The funding community which the exploitation Plan belong to
   */
  @Input() fundingCommunity: Community;

  public exploitationPlanId: string;

  /**
   * Array to track all subscriptions and unsubscribe them onDestroy
   */
  private subs: Subscription[] = [];

  /**
   * A boolean representing if compare mode is active
   */
  compareMode: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);

  constructor(protected exploitationPlanStateService: ExploitationPlanStateService) {
  }

  ngOnInit(): void {
    this.exploitationPlanId = this.exploitationPlan ?.id;

    this.subs.push(
      this.exploitationPlanStateService.isCompareModeActive()
        .subscribe((compareMode: boolean) => this.compareMode.next(compareMode))
    );

  }

  getExploitationPlanStep(): Observable<ExploitationPlanStep[]> {
    return this.exploitationPlanStateService.getExploitationPlanStep(this.exploitationPlanId);
  }

  isLoading(): Observable<boolean> {
    return this.exploitationPlanStateService.isExploitationPlanLoaded().pipe(
      map((loaded: boolean) => !loaded)
    );
  }

  /**
   * Dispatch initialization of comparing mode
   *
   * @param version
   */
  onVersionSelected(version: Item) {
    this.exploitationPlanStateService.dispatchInitCompare(this.exploitationPlan ?.id, version.id);
  }

  /**
   * Dispatch cleaning of comparing mode
   */
  onVersionDeselected() {
    this.exploitationPlanStateService.dispatchStopCompare(this.exploitationPlan ?.id);
  }

  /**
   * When destroy component clear all collapsed values.
   */
  ngOnDestroy() {
    this.exploitationPlanStateService.dispatchClearCollapsable();

    this.subs
      .filter((subscription) => hasValue(subscription))
      .forEach((subscription) => subscription.unsubscribe());
  }
}
